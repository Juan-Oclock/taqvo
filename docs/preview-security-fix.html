<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Fix: Activity Deletion Authorization</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #1c1c1e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .phone-mockup {
            background: #1c1c1e;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }
        .screen {
            background: #000;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            min-height: 400px;
        }
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        .delete-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .hidden {
            opacity: 0.3;
            text-decoration: line-through;
        }
        .security-check {
            background: #1e3a8a;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }
        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .highlight {
            background: #ffd60a;
            color: #000;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .success {
            color: #30d158;
        }
        .error {
            color: #ff453a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Security Fix: Activity Deletion Authorization</h1>
        
        <div class="section">
            <h2>Issue Identified</h2>
            <p>Users could delete other users' public activities from the activity detail view, even though they weren't the owners. This was a critical security vulnerability.</p>
        </div>

        <div class="section">
            <h2>Before vs After Fix</h2>
            <div class="before-after">
                <div class="phone-mockup">
                    <h3 class="error">‚ùå Before (Vulnerable)</h3>
                    <div class="screen">
                        <div class="nav-bar">
                            <span>‚Üê Activity Detail</span>
                            <button class="delete-btn">üóë Delete</button>
                        </div>
                        <p><strong>User A's Activity</strong></p>
                        <p>Distance: 5.2 km</p>
                        <p>Duration: 25:30</p>
                        <p>Pace: 4:54 /km</p>
                        <div style="margin-top: 20px; padding: 10px; background: #ff3b30; border-radius: 6px;">
                            <strong>‚ö†Ô∏è Security Issue:</strong><br>
                            User B can see and click the delete button for User A's activity!
                        </div>
                    </div>
                </div>
                
                <div class="phone-mockup">
                    <h3 class="success">‚úÖ After (Secure)</h3>
                    <div class="screen">
                        <div class="nav-bar">
                            <span>‚Üê Activity Detail</span>
                            <span class="hidden">üóë Delete</span>
                        </div>
                        <p><strong>User A's Activity</strong></p>
                        <p>Distance: 5.2 km</p>
                        <p>Duration: 25:30</p>
                        <p>Pace: 4:54 /km</p>
                        <div style="margin-top: 20px; padding: 10px; background: #30d158; border-radius: 6px; color: #000;">
                            <strong>‚úÖ Secure:</strong><br>
                            User B cannot see the delete button for User A's activity
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Implementation Details</h2>
            
            <h3>1. UI-Level Protection</h3>
            <p>Added ownership validation in <code>ActivityDetailView.swift</code>:</p>
            <div class="code-block">
<span class="highlight">private var isOwner: Bool {</span>
    guard let currentUserId = SupabaseAuthManager.shared.userId else { return false }
    return activity.userId == currentUserId
}

.toolbar {
    <span class="highlight">if isOwner {</span>
        ToolbarItem(placement: .navigationBarTrailing) {
            Button(role: .destructive) {
                showDeleteConfirm = true
            } label: {
                Label("Delete", systemImage: "trash")
            }
        }
    }
}
            </div>

            <h3>2. Backend-Level Protection</h3>
            <p>Added server-side validation in <code>ActivityStore.swift</code>:</p>
            <div class="code-block">
func delete(activity: FeedActivity) {
    <span class="highlight">// Security check: Only allow deletion if user owns the activity</span>
    <span class="highlight">guard let currentUserId = SupabaseAuthManager.shared.userId,</span>
    <span class="highlight">          activity.userId == currentUserId else {</span>
        print("Unauthorized delete attempt: User \(SupabaseAuthManager.shared.userId ?? "unknown") tried to delete activity owned by \(activity.userId)")
        return
    }
    
    activities.removeAll { $0.id == activity.id }
    save()
}
            </div>
        </div>

        <div class="section">
            <h2>Security Layers</h2>
            <div class="security-check">
                <h4>üõ°Ô∏è Double Protection</h4>
                <ul>
                    <li><strong>UI Layer:</strong> Delete button only appears for activity owners</li>
                    <li><strong>Data Layer:</strong> Delete operation validates ownership before execution</li>
                    <li><strong>Logging:</strong> Unauthorized attempts are logged for monitoring</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>Test Scenarios</h2>
            <h3>‚úÖ Authorized Actions (Owner)</h3>
            <ul>
                <li>User can see delete button on their own activities</li>
                <li>User can successfully delete their own activities</li>
                <li>Delete confirmation dialog appears</li>
            </ul>

            <h3>üö´ Blocked Actions (Non-Owner)</h3>
            <ul>
                <li>User cannot see delete button on others' activities</li>
                <li>Even if bypassed, delete operation fails silently</li>
                <li>Unauthorized attempts are logged</li>
            </ul>
        </div>

        <div class="section">
            <h2>Impact</h2>
            <p>This fix ensures that:</p>
            <ul>
                <li>Users can only delete their own activities</li>
                <li>Public activities from other users remain protected</li>
                <li>The feed maintains data integrity</li>
                <li>User trust and privacy are preserved</li>
            </ul>
        </div>
    </div>
</body>
</html>